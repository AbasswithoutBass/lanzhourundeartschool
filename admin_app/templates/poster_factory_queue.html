<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>海报工厂 - 审核队列</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"PingFang SC",sans-serif;background:#f5f5f7;margin:0}
    header{background:#fff;border-bottom:1px solid rgba(0,0,0,.06);padding:14px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    a{color:#660874;text-decoration:none}
    .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
    .card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.06)}
    .poster-shell{display:grid;grid-template-columns:1fr 320px;gap:16px;align-items:start}
    @media(max-width:980px){.poster-shell{grid-template-columns:1fr}}

    /* --- Tech/Commercial Style Poster CSS --- */
    .poster-frame{background:#fff;border-radius:18px;overflow:hidden;border:1px solid rgba(0,0,0,.06);box-shadow:0 20px 48px rgba(0,0,0,0.12);transform-origin:center bottom}
    .poster{width:100%;aspect-ratio:9/16;background:#1a0b2e;position:relative;overflow:hidden;color:#fff;font-family:"PingFang SC", sans-serif}
    
    /* Backgrounds */
    .poster-bg-grad {position:absolute;inset:0;background:radial-gradient(circle at 100% 0%, #4a0e69 0%, #1a0b2e 50%, #000 100%); z-index:0;}
    /* Stable CSS pattern noise (no SVG) */
    .poster-noise {position:absolute;inset:0;opacity:0.12;background:repeating-linear-gradient(45deg, rgba(255,255,255,0.03) 0, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 10px);pointer-events:none;z-index:0;}
    /* Particles + haze + vignette + light leaks (no backdrop-filter; export-friendly) */
    .poster-particles{position:absolute;inset:0;opacity:0.18;pointer-events:none;z-index:0;
      background:
        radial-gradient(circle at 20% 30%, rgba(255,215,0,0.25) 0 2px, transparent 3px),
        radial-gradient(circle at 70% 20%, rgba(120,70,255,0.18) 0 2px, transparent 3px),
        radial-gradient(circle at 60% 65%, rgba(255,255,255,0.12) 0 1px, transparent 2px),
        radial-gradient(circle at 35% 75%, rgba(255,215,0,0.18) 0 1px, transparent 2px),
        radial-gradient(circle at 85% 55%, rgba(255,255,255,0.10) 0 1px, transparent 2px);
    }
    .poster-haze{position:absolute;inset:0;pointer-events:none;z-index:0;opacity:0.55;
      background:radial-gradient(circle at 50% 52%, rgba(120,70,255,0.22) 0%, rgba(255,215,0,0.10) 22%, transparent 55%);
    }
    .poster-vignette{position:absolute;inset:0;pointer-events:none;z-index:2;opacity:0.9;
      background:radial-gradient(circle at 50% 45%, transparent 38%, rgba(0,0,0,0.25) 62%, rgba(0,0,0,0.55) 100%);
    }
    .light-leak{position:absolute;inset:0;pointer-events:none;z-index:1;opacity:0.55;}
    .light-leak.tl{background:radial-gradient(circle at 0% 0%, rgba(90,160,255,0.35) 0%, rgba(90,160,255,0.10) 24%, transparent 52%);} 
    .light-leak.tr{background:radial-gradient(circle at 100% 0%, rgba(140,90,255,0.30) 0%, rgba(140,90,255,0.08) 24%, transparent 54%);} 
    .light-leak.bl{background:radial-gradient(circle at 0% 100%, rgba(90,160,255,0.22) 0%, rgba(90,160,255,0.06) 24%, transparent 58%);} 
    .light-leak.br{background:radial-gradient(circle at 100% 100%, rgba(255,215,0,0.22) 0%, rgba(255,215,0,0.06) 26%, transparent 60%);} 

    /* Abstract middle elements: ribbon + waveform geometry */
    .mid-ribbon{position:absolute;left:-20%;top:48%;width:140%;height:120px;border-radius:999px;transform:rotate(-12deg);
      background:linear-gradient(90deg, transparent 0%, rgba(255,215,0,0.10) 18%, rgba(255,255,255,0.10) 40%, rgba(255,215,0,0.18) 52%, rgba(140,90,255,0.14) 72%, transparent 100%);
      opacity:0.85;pointer-events:none;z-index:1;
      box-shadow:0 18px 80px rgba(255,215,0,0.12);
    }
    .mid-wave{position:absolute;left:-10%;top:56%;width:120%;height:180px;transform:rotate(8deg);
      background:
        repeating-linear-gradient(90deg, rgba(255,255,255,0.06) 0 2px, transparent 2px 10px),
        radial-gradient(circle at 50% 50%, rgba(120,70,255,0.16) 0%, transparent 55%);
      border-radius:28px;opacity:0.55;pointer-events:none;z-index:1;
    }
    .poster-blob {position:absolute;width:400px;height:400px;background:#8b2a9b;filter:blur(80px);border-radius:50%;opacity:0.4;top:-100px;left:-100px;z-index:0;}
    .poster-blob2 {position:absolute;width:300px;height:300px;background:#d4af37;filter:blur(90px);border-radius:50%;opacity:0.2;bottom:0;right:-50px;z-index:0;}

    /* Decorations */
    .deco-line {position:absolute;left:24px;top:24px;bottom:24px;width:1px;background:rgba(255,255,255,0.15);z-index:1;}
    .deco-cross {position:absolute;right:24px;top:24px;font-size:24px;font-weight:100;color:rgba(255,255,255,0.3);z-index:1;}
    .deco-circle-line {position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:500px;height:500px;border:1px dashed rgba(255,255,255,0.1);border-radius:50%;pointer-events:none;z-index:0;}

    /* Content Layers */
    .layer-top {position:absolute;top:40px;left:40px;right:24px;z-index:10;}
    /* Removed backdrop-filter to match downloaded image rendering */
    .brand-pill {display:inline-flex;align-items:center;padding:6px 14px;background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);border-radius:99px;font-size:12px;font-weight:700;letter-spacing:1px;margin-bottom:14px;color:#fff;}
    .brand-pill span {color:#FFD700;margin-right:6px;}

    .layer-hero {position:absolute;top:120px;left:0;right:0;text-align:center;z-index:5;}
    /* Avatar with Golden Ring */
    .avatar-ring {
      width:140px;height:140px;margin:0 auto;
      border-radius:50%;padding:4px;
      background:conic-gradient(from 0deg, rgba(255,215,0,1), rgba(255,255,255,0.85), rgba(255,215,0,1), rgba(184,134,11,1), rgba(255,215,0,1));
      box-shadow:0 20px 50px rgba(0,0,0,0.5), 0 0 22px rgba(140,90,255,0.22);
      position:relative;
    }
    /* Multi glowing rings */
    .avatar-ring::before{content:"";position:absolute;inset:-10px;border-radius:50%;
      background:conic-gradient(from 90deg, rgba(140,90,255,0.55), rgba(255,215,0,0.50), rgba(255,255,255,0.35), rgba(140,90,255,0.55));
      opacity:0.65;filter:blur(0.2px);pointer-events:none;
      box-shadow:0 0 28px rgba(140,90,255,0.35), 0 0 36px rgba(255,215,0,0.22);
    }
    .avatar-ring::after{content:"";position:absolute;inset:-18px;border-radius:50%;
      background:radial-gradient(circle at 50% 50%, rgba(255,215,0,0.14) 0%, rgba(140,90,255,0.10) 34%, transparent 64%);
      opacity:0.9;pointer-events:none;
    }
    .avatar-inner {width:100%;height:100%;border-radius:50%;background:#000;overflow:hidden;border:3px solid rgba(255,255,255,0.95);position:relative;box-shadow:0 0 18px rgba(90,160,255,0.18), 0 0 10px rgba(255,215,0,0.12);}
    .avatar-inner img {width:100%;height:100%;object-fit:cover;display:block;transform:translate(var(--px,0),var(--py,0)) scale(var(--ps,1))}
    
    /* Name & Title */
    .student-name {font-size:36px;font-weight:900;margin-top:20px;letter-spacing:4px;text-shadow:0 4px 12px rgba(0,0,0,0.5);}
    .category-tag {display:inline-block;margin-top:8px;padding:4px 12px;background:#FFD700;color:#000;font-weight:800;font-size:12px;border-radius:4px;transform:skewX(-10deg);}
    .location-line {margin-top:8px;font-size:13px;color:rgba(255,255,255,0.6);font-weight:400;letter-spacing:2px;}

    /* The BIG Score Section */
    .big-stat-box {position:absolute;top:400px;left:0;right:0;text-align:center;z-index:10;}
    .marketing-text {font-size:30px;font-weight:900;font-style:italic;line-height:1.2;background:linear-gradient(180deg, #fff 40%, #ccc 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 12px 26px rgba(0,0,0,0.55);}
    .score-caption{margin-top:8px;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,0.55);}
    .score-hero {
      font-family:Impact, sans-serif;
      font-size:100px;
      line-height:0.9;
      background:linear-gradient(180deg, #FFF2B0 0%, #FFD700 24%, #B8860B 74%, #FFD700 100%);
      background-size:200% 200%;
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      filter:drop-shadow(0 6px 0px rgba(255,255,255,0.10)) drop-shadow(0 14px 28px rgba(0,0,0,0.55)) drop-shadow(0 0 18px rgba(255,215,0,0.18));
      margin-top:10px;
      display:flex;align-items:baseline;justify-content:center;
    }
    @keyframes goldShine{0%{background-position:0% 30%}50%{background-position:90% 60%}100%{background-position:0% 30%}}
    .score-hero{animation:goldShine 5s ease-in-out infinite;}
    .score-hero .unit {font-size:24px;font-family:sans-serif;font-weight:700;color:rgba(255,255,255,0.8);-webkit-text-fill-color:rgba(255,255,255,0.8);margin-left:6px;}

    /* Glass Panels for Meta Data */
    .glass-deck {position:absolute;bottom:40px;left:24px;right:24px;display:flex;gap:10px;z-index:10;}
    /* Removed backdrop-filter to keep preview & download consistent */
    .glass-card {flex:1;background:rgba(20, 10, 30, 0.7);border:1px solid rgba(255,255,255,0.3);border-radius:12px;padding:14px;text-align:left;}
    .glass-card .lbl {font-size:11px;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;}
    .glass-card .val {font-size:20px;font-weight:700;color:#fff;}
    .glass-card .sub {font-size:11px;color:#FFD700;margin-top:2px;}

    /* Floating Badges */
    .float-badge {position:absolute;right:30px;top:380px;background:#FF4500;color:#fff;font-weight:bold;padding:6px 12px;border-radius:8px;font-size:12px;box-shadow:0 8px 16px rgba(255,69,0,0.4);transform:rotate(10deg);z-index:20;}

    /* Extra metrics to reduce empty space */
    .mini-row{position:absolute;left:24px;right:24px;bottom:140px;display:flex;gap:10px;z-index:10;}
    .mini-pill{flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.18);border-radius:12px;padding:10px 12px;}
    .mini-pill .k{font-size:11px;color:rgba(255,255,255,0.55);letter-spacing:1px;}
    .mini-pill .v{margin-top:3px;font-size:16px;font-weight:800;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .tag-row{position:absolute;left:24px;right:24px;bottom:220px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center;z-index:10;}
    .tag-chip{padding:6px 10px;border-radius:999px;font-size:11px;font-weight:700;letter-spacing:1px;color:rgba(255,255,255,0.85);background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.18);}
    .poster-footer{position:absolute;left:24px;right:24px;bottom:14px;display:flex;justify-content:space-between;gap:10px;z-index:10;color:rgba(255,255,255,0.55);font-size:11px;letter-spacing:1px;}
    .poster-footer .id{color:rgba(255,255,255,0.75);font-weight:700;}

    /* Top title typesetting */
    .year-line{font-size:11px;color:rgba(255,255,255,0.62);letter-spacing:2px;}
    .report-title{font-size:18px;font-weight:600;margin-top:4px;letter-spacing:5px;color:rgba(255,255,255,0.92);text-transform:uppercase;}

    /* Export mode: keep html2canvas output close to what user sees */
    .export-mode, .export-mode *{animation:none !important; transition:none !important;}
    /* html2canvas has weak support for conic-gradient / filters; provide stable fallback during export */
    .export-mode .avatar-ring{background:radial-gradient(circle at 35% 30%, rgba(255,255,255,0.55) 0%, rgba(255,215,0,1) 22%, rgba(184,134,11,1) 62%, rgba(255,215,0,1) 100%) !important;}
    .export-mode .avatar-ring::before{background:radial-gradient(circle at 50% 50%, rgba(140,90,255,0.35) 0%, rgba(255,215,0,0.28) 42%, transparent 66%) !important; box-shadow:0 0 22px rgba(140,90,255,0.30), 0 0 26px rgba(255,215,0,0.18) !important;}
    .export-mode .avatar-ring::after{background:radial-gradient(circle at 50% 50%, rgba(255,215,0,0.12) 0%, rgba(140,90,255,0.08) 38%, transparent 70%) !important;}
    .export-mode .poster-blob, .export-mode .poster-blob2{display:none !important;}
    .export-mode .score-hero{filter:none !important; background-position:0% 30% !important;}
    .export-mode #heroScore, .export-mode #heroUnit{text-shadow:0 14px 28px rgba(0,0,0,0.55), 0 0 18px rgba(255,215,0,0.16) !important;}

    .side{display:flex;flex-direction:column;gap:10px}
    .btn{display:inline-block;padding:10px 12px;border-radius:12px;background:#6f42c1;color:#fff;font-weight:700;border:none;cursor:pointer}
    .btn2{display:inline-block;padding:10px 12px;border-radius:12px;background:#fff;color:#6f42c1;font-weight:700;border:1px solid rgba(111,66,193,0.25);cursor:pointer}
    .btnGood{background:#16a34a;color:#fff}
    .btnBad{background:#ef4444;color:#fff}
    .k{font-size:12px;color:#666;line-height:1.6}
    .status{font-size:12px;padding:4px 10px;border-radius:999px;background:rgba(0,0,0,0.06);color:#444;font-weight:700}

    /* Animations */
    .swipe-out-right { animation: swipeRight 0.4s cubic-bezier(0.4,0,0.2,1) forwards; }
    .swipe-out-left { animation: swipeLeft 0.4s cubic-bezier(0.4,0,0.2,1) forwards; }
    .fade-in { animation: fadeIn 0.4s ease forwards; }

    @keyframes swipeRight { to { transform: translateX(120%) rotate(15deg); opacity: 0; } }
    @keyframes swipeLeft { to { transform: translateX(-120%) rotate(-15deg); opacity: 0; } }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
  </style>
</head>
<body>
  <header>
    <div style="font-weight:800">海报工厂 · 审核队列</div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <a href="/admin">返回后台首页</a>
      <a href="/admin/students-db">学生数据库</a>
      <a href="/logout">退出</a>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <div id="empty" class="k" style="display:none">暂无需要生成的海报。请在学生数据库设置海报张数。</div>
      <div id="shell" class="poster-shell" style="display:none">
        <div class="poster-frame">
          <div id="poster" class="poster">
            <div class="poster-bg-grad"></div>
            <div class="poster-noise"></div>
            <div class="poster-particles"></div>
            <div class="poster-haze"></div>
            <div class="mid-ribbon"></div>
            <div class="mid-wave"></div>
            <div class="poster-blob"></div>
            <div class="poster-blob2"></div>
            <div class="light-leak tl"></div>
            <div class="light-leak tr"></div>
            <div class="light-leak bl"></div>
            <div class="light-leak br"></div>
            
            <div class="deco-line"></div>
            <div class="deco-cross">+</div>
            <div class="deco-circle-line"></div>
            
            <div class="layer-top">
                <div class="brand-pill"><span>RUNDE</span> ART SCHOOL</div>
                <div class="year-line" id="yearText">2026 OFFICIAL REPORT —</div>
                <div class="report-title">润德艺考 · 喜报</div>
            </div>

            <div class="layer-hero">
                <div class="avatar-ring">
                    <div class="avatar-inner">
                        <img id="avatarImg" src="" alt="avatar">
                    </div>
                </div>
                
                <div class="student-name" id="nameText">—</div>
                <div class="location-line" id="locationText">—</div>
                <div id="metaText" class="category-tag">—</div>
            </div>

            <div class="float-badge" id="floatBadge">TOP 1%</div>

            <div class="big-stat-box">
                <div class="marketing-text" id="campaignText">制霸高分 · 强势上岸</div>
              <div class="score-caption" id="scoreCaption">ACADEMIC PERFORMANCE</div>
                <div class="score-hero">
                    <span id="heroScore">—</span>
                    <span class="unit" id="heroUnit">分</span>
                </div>
            </div>

            <div class="tag-row" id="tagRow"></div>

            <div class="mini-row" id="miniRow">
              <div class="mini-pill">
                <div class="k" id="mini1Label">—</div>
                <div class="v" id="mini1Value">—</div>
              </div>
              <div class="mini-pill">
                <div class="k" id="mini2Label">—</div>
                <div class="v" id="mini2Value">—</div>
              </div>
              <div class="mini-pill">
                <div class="k" id="mini3Label">—</div>
                <div class="v" id="mini3Value">—</div>
              </div>
            </div>

            <div class="glass-deck" id="rankDeck">
              <div class="glass-card" id="scoreCard">
                    <div class="lbl" id="scoreLabel">主项分数</div>
                    <div class="val" id="scoreValue">—</div>
                    <div class="sub">超过98%考生</div>
                </div>
              <div class="glass-card" id="rankCard">
                    <div class="lbl" id="rankLabel">主项排名</div>
                    <div class="val" id="rankValue">—</div>
                    <div class="sub">全省前列</div>
                </div>
            </div>

            <div class="poster-footer">
              <div id="footerLeft">RUNDE ART SCHOOL · POSTER FACTORY</div>
              <div class="id" id="footerRight">ID —</div>
            </div>

            <div class="poster-vignette"></div>
          </div>
        </div>
        <div class="side">
          <div class="k">快捷键：Enter=合格，Backspace=不合格</div>
          <div class="k">当前状态：<span id="statusTag" class="status">pending</span></div>
          <div class="k">当前学生：<span id="studentId">—</span></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="btnGood" class="btn btnGood" type="button">合格</button>
            <button id="btnBad" class="btn btnBad" type="button">不合格</button>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="btnPrev" class="btn2" type="button">上一张</button>
            <button id="btnNext" class="btn2" type="button">下一张</button>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <a id="btnEdit" class="btn2" href="#">单张精修页</a>
          </div>
          <div>
            <label class="k">海报类型</label>
            <select id="posterType" class="btn2" style="width:100%">
              <option value="main">主项海报</option>
              <option value="sub">副项海报</option>
              <option value="ear">听写海报</option>
              <option value="theory">乐理海报</option>
              <option value="sight">视唱海报</option>
              <option value="total">综合海报</option>
            </select>
          </div>
          <div>
            <label class="k">清晰度</label>
            <select id="quality" class="btn2" style="width:100%">
              <option value="1">社交版 1080×1920</option>
              <option value="1.33">高清 1440×2560</option>
              <option value="2">超清 2160×3840</option>
            </select>
          </div>
          <button id="btnDownload" class="btn" type="button">下载当前海报</button>
        </div>
      </div>
    </div>
  </div>

  <script id="posterData" type="application/json">{{ students|tojson }}</script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    const data = JSON.parse(document.getElementById('posterData').textContent || '[]');
    let idx = 0;
    const rejectCounts = {};

    const $ = (id)=>document.getElementById(id);
    const posterFrame = document.querySelector('.poster-frame');

    const raf = ()=>new Promise(r=>requestAnimationFrame(()=>r()));

    async function prepareExport(node){
      node.classList.add('export-mode');
      try{
        if(document.fonts && document.fonts.ready) await document.fonts.ready;
      }catch{}
      const imgs = Array.from(node.querySelectorAll('img'));
      await Promise.all(imgs.map(async (img)=>{
        try{
          if(!img || !img.src) return;
          if(img.decode) await img.decode();
        }catch{}
      }));
      await raf();
      await raf();
    }

    function cleanupExport(node){
      node.classList.remove('export-mode');
    }

    function pickPhoto(s){
      const p = s.photo || '';
      return p ? ('/site/' + encodeURI(p)) : '/site/润德1.png';
    }

    function render(){
      if(!data.length){
        $('empty').style.display = 'block';
        $('shell').style.display = 'none';
        return;
      }
      if(idx >= data.length){
        alert('队列已审核完毕！即将返回后台首页。');
        window.location.href = '/admin';
        return;
      }

      $('empty').style.display = 'none';
      $('shell').style.display = 'grid';

      // Animation reset
      posterFrame.className = 'poster-frame fade-in';

      const s = data[idx];
      let posterTypes = Array.isArray(s.posterTypes) ? s.posterTypes : [];
      if(!posterTypes.length && s.posterMode){
        const m = String(s.posterMode);
        if(m === '1') posterTypes = ['main'];
        if(m === '2') posterTypes = ['main','sub'];
        if(m === '3') posterTypes = ['main','sub','total'];
      }
      
      const typeSel = $('posterType');
      const opts = Array.from(typeSel.options).map(o=>o.value);
      const available = opts.filter(v => posterTypes.includes(v));
      if(!available.length){
        typeSel.value = 'main';
        typeSel.disabled = true;
      }else{
        // Preserve selection if possible, else pick first available
        if(!available.includes(typeSel.value)) typeSel.value = available[0];
        typeSel.disabled = false;
      }

      updatePosterInfo(s, typeSel.value);
    }

    function updatePosterInfo(s, type){
      $('nameText').textContent = s.name || '未命名';
      $('yearText').textContent = (s.year || '2026') + ' OFFICIAL REPORT —';
      $('metaText').textContent = [s.category, s.mainSubject, s.subSubject].filter(Boolean).join(' / ') || '—';
      const examPlace = [s.examProvince, s.examCity].filter(Boolean).join(' · ');
      $('locationText').textContent = examPlace || '—';

      $('footerRight').textContent = 'ID ' + (s.id || '—');
      
      $('studentId').textContent = s.id || '—';
      $('statusTag').textContent = s.posterStatus || 'pending';
      $('btnEdit').href = '/admin/poster-factory/' + s.id;

      const avatar = $('avatarImg');
      avatar.src = pickPhoto(s);
      avatar.style.setProperty('--ps', s.posterPhotoScale || '1');
      avatar.style.setProperty('--px', (s.posterPhotoX || '0') + 'px');
      avatar.style.setProperty('--py', (s.posterPhotoY || '0') + 'px');

      // Respect per-student rank display setting
      const showRank = String(s.posterShowRank || '1') !== '0';
      const rankCard = document.getElementById('rankCard');
      if(rankCard) rankCard.style.display = showRank ? '' : 'none';

      let slogan = '制霸高分 · 强势上岸';
      let floatText = 'TOP 5%';
      let caption = 'ACADEMIC PERFORMANCE';

      // Defaults for mini metrics
      let m1l = '专业';
      let m1v = (s.category || '—');
      let m2l = '地区';
      let m2v = (examPlace || '—');
      let m3l = '总分';
      let m3v = (s.totalScore || '—');

      if(type === 'main'){
        $('scoreLabel').textContent = '主项分数';
        $('rankLabel').textContent = '主项排名';
        $('scoreValue').textContent = s.mainScore || '—';
        $('rankValue').textContent = s.mainRank || '—';
        $('heroScore').textContent = s.mainScore || '—';
        $('heroUnit').textContent = '分';
        slogan = '主项强基 · 技压群雄';
        floatText = '单科状元';
        caption = 'ACADEMIC PERFORMANCE';

        m1l = '主项';
        m1v = s.mainSubject || '—';
        m2l = '主项分数';
        m2v = s.mainScore || '—';
        m3l = '主项排名';
        m3v = s.mainRank || '—';
      }else if(type === 'sub'){
        $('scoreLabel').textContent = '副项分数';
        $('rankLabel').textContent = '专业排名';
        $('scoreValue').textContent = s.subScore || '—';
        $('rankValue').textContent = s.majorRank || '—';
        $('heroScore').textContent = s.subScore || '—';
        $('heroUnit').textContent = '分';
        slogan = '多才多艺 · 全面开花';
        floatText = '全能发展';
        caption = 'SUBJECT PERFORMANCE';

        m1l = '副项';
        m1v = s.subSubject || '—';
        m2l = '副项分数';
        m2v = s.subScore || '—';
        m3l = '专业排名';
        m3v = s.majorRank || '—';
      }else if(type === 'ear'){
        $('scoreLabel').textContent = '听写分数';
        $('rankLabel').textContent = '专业排名';
        $('scoreValue').textContent = s.earTraining || '—';
        $('rankValue').textContent = s.majorRank || '—';
        $('heroScore').textContent = s.earTraining || '—';
        $('heroUnit').textContent = '分';
        slogan = '听音辨位 · 稳定高分';
        floatText = '基本功';
        caption = 'SKILL PERFORMANCE';

        m1l = '主项';
        m1v = s.mainSubject || '—';
        m2l = '听写';
        m2v = s.earTraining || '—';
        m3l = '专业排名';
        m3v = s.majorRank || '—';
      }else if(type === 'theory'){
        $('scoreLabel').textContent = '乐理分数';
        $('rankLabel').textContent = '专业排名';
        $('scoreValue').textContent = s.theory || '—';
        $('rankValue').textContent = s.majorRank || '—';
        $('heroScore').textContent = s.theory || '—';
        $('heroUnit').textContent = '分';
        slogan = '乐理高分 · 基础扎实';
        floatText = '理论扎实';
        caption = 'THEORY PERFORMANCE';

        m1l = '主项';
        m1v = s.mainSubject || '—';
        m2l = '乐理';
        m2v = s.theory || '—';
        m3l = '专业排名';
        m3v = s.majorRank || '—';
      }else if(type === 'sight'){
        $('scoreLabel').textContent = '视唱分数';
        $('rankLabel').textContent = '专业排名';
        $('scoreValue').textContent = s.sightSinging || '—';
        $('rankValue').textContent = s.majorRank || '—';
        $('heroScore').textContent = s.sightSinging || '—';
        $('heroUnit').textContent = '分';
        slogan = '视唱练耳 · 唯快不破';
        floatText = '视唱强项';
        caption = 'SIGHT-SINGING PERFORMANCE';

        m1l = '主项';
        m1v = s.mainSubject || '—';
        m2l = '视唱';
        m2v = s.sightSinging || '—';
        m3l = '专业排名';
        m3v = s.majorRank || '—';
      }else{
        $('scoreLabel').textContent = '专业总分';
        $('rankLabel').textContent = '全省排名';
        $('scoreValue').textContent = s.totalScore || '—';
        $('rankValue').textContent = s.majorRank || '—';
        $('heroScore').textContent = s.totalScore || '—';
        $('heroUnit').textContent = '分';
        slogan = '制霸考场 · 综合王者';
        floatText = '全省前茅';
        caption = 'OVERALL PERFORMANCE';

        m1l = '专业总分';
        m1v = s.totalScore || '—';
        m2l = '专业排名';
        m2v = s.majorRank || '—';
        m3l = '主项分数';
        m3v = s.mainScore || '—';
      }
      
      $('campaignText').textContent = slogan;
      $('floatBadge').textContent = floatText;
      $('scoreCaption').textContent = caption;

      // Tags (can be many; never show "满分")
      const tagRow = $('tagRow');
      const uniq = (arr)=>{
        const seen = new Set();
        return arr.filter(x=>{
          const k = String(x || '').trim();
          if(!k) return false;
          if(seen.has(k)) return false;
          seen.add(k);
          return true;
        });
      };
      const safeTag = (t)=>String(t || '').replace(/满分/g, '高分').trim();
      const arrify = (v)=>Array.isArray(v) ? v : (v ? [v] : []);
      const parseTags = (v)=>{
        if(Array.isArray(v)) return v;
        const s = String(v || '').trim();
        if(!s) return [];
        return s.split(/[\n,，;；|\/]+/g).map(x=>x.trim()).filter(Boolean);
      };
      const typeTag = {
        main: '主项突击',
        sub: '副项提升',
        ear: '听写训练',
        theory: '乐理强化',
        sight: '视唱训练',
        total: '综合实力'
      }[type] || '综合实力';

      const extraTags = uniq([
        ...parseTags(s.posterTags),
        ...parseTags(s.tags),
        ...arrify(s.posterTagsArr),
        safeTag(s.campus),
        safeTag(s.className),
        safeTag(s.teacher),
        safeTag(s.targetSchool),
        safeTag(s.admitSchool)
      ].filter(Boolean).map(safeTag));

      const tags = uniq([
        safeTag((s.year || '2026') + '届'),
        safeTag(s.category),
        safeTag(s.mainSubject),
        safeTag(s.subSubject),
        safeTag(examPlace),
        typeTag,
        '润德艺考',
        '官方报告',
        ...extraTags
      ]).slice(0, 12);

      tagRow.innerHTML = tags.map(t=>`<span class="tag-chip">${t}</span>`).join('');

      $('mini1Label').textContent = m1l;
      $('mini1Value').textContent = m1v;
      $('mini2Label').textContent = m2l;
      $('mini2Value').textContent = m2v;
      $('mini3Label').textContent = m3l;
      $('mini3Value').textContent = m3v;
    }

    const wait = (ms) => new Promise(r => setTimeout(r, ms));

    async function setStatus(status){
      const s = data[idx];
      const fd = new FormData();
      fd.append('status', status);
      
      // Update backend status silently first? or after? 
      // User experience: click -> animate -> finish.
      
      fetch('/admin/poster-factory/' + s.id + '/status', {method:'POST', body: fd}); // Fire and forget for speed feeling

      if(status === 'approved'){
        posterFrame.className = 'poster-frame swipe-out-right';
        s.posterStatus = 'approved';
        $('statusTag').textContent = 'approved';
        await wait(450);
        idx++; // Advance to next
        render();
      } else {
        // Rejected
        s.posterStatus = 'rejected';
        $('statusTag').textContent = 'rejected';
        
        const count = (rejectCounts[s.id] || 0) + 1;
        rejectCounts[s.id] = count;

        if(count >= 3){
          alert('该生（' + s.name + '）已连续 3 次不合格，建议进入“单张精修”进行调整。');
          window.location.href = '/admin/poster-factory/' + s.id;
          return;
        }

        posterFrame.className = 'poster-frame swipe-out-left';
        await wait(450);
        
        // "Regenerate" / Refresh current
        render(); 
        // Note: idx does not increment, so it shows the same student again.
        // The .fade-in animation in render() gives the feeling of a new card appearing.
      }
    }

    function moveManually(step){
       idx += step;
       if(idx < 0) idx = data.length - 1;
       if(idx >= data.length) idx = 0;
       render();
    }

    async function download(){
      const scale = parseFloat($('quality').value || '1');
      const node = $('poster');
      await prepareExport(node);
      const canvas = await html2canvas(node, {
        scale,
        backgroundColor: null,
        useCORS: true,
        allowTaint: true,
        logging: false,
        scrollX: 0,
        scrollY: 0,
        onclone: (doc)=>{
          try{ doc.getElementById('poster')?.classList.add('export-mode'); }catch{}
        }
      });
      cleanupExport(node);
      const link = document.createElement('a');
      const s = data[idx];
      const type = $('posterType').value;
      link.download = `${s.name || 'poster'}_${type}_${scale}x.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    $('btnGood').addEventListener('click', ()=> setStatus('approved'));
    $('btnBad').addEventListener('click', ()=> setStatus('rejected'));
    
    // Manual navigation buttons (retain old circular behavior or just move?)
    $('btnNext').addEventListener('click', ()=> moveManually(1));
    $('btnPrev').addEventListener('click', ()=> moveManually(-1));
    
    $('btnDownload').addEventListener('click', download);
    $('posterType').addEventListener('change', ()=> updatePosterInfo(data[idx], $('posterType').value));

    document.addEventListener('keydown', (e)=>{
      if($('shell').style.display === 'none') return;
      if(e.key === 'Enter'){ e.preventDefault(); setStatus('approved'); }
      if(e.key === 'Backspace'){ e.preventDefault(); setStatus('rejected'); }
      if(e.key === 'ArrowRight'){ moveManually(1); }
      if(e.key === 'ArrowLeft'){ moveManually(-1); }
    });

    render();
  </script>
</body>
</html>
