<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>海报工厂 - 审核队列</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"PingFang SC",sans-serif;background:#f5f5f7;margin:0}
    header{background:#fff;border-bottom:1px solid rgba(0,0,0,.06);padding:14px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    a{color:#660874;text-decoration:none}
    .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
    .card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.06)}
    .poster-shell{display:grid;grid-template-columns:1fr 320px;gap:16px;align-items:start}
    @media(max-width:980px){.poster-shell{grid-template-columns:1fr}}
    
    /* New Commercial Style */
    .poster-frame{background:#fff;border-radius:18px;overflow:hidden;border:1px solid rgba(0,0,0,.06);box-shadow:0 20px 48px rgba(0,0,0,0.12);transform-origin:center bottom}
    .poster{width:100%;aspect-ratio:9/16;background:#fff;position:relative;overflow:hidden}
    .poster-bg{position:absolute;inset:0;background:radial-gradient(circle at 50% 25%, #6a0b7d 0%, #2a0333 100%)}
    .poster::after{content:'';position:absolute;inset:0;background:repeating-linear-gradient(45deg, rgba(255,255,255,0.03) 0, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 10px);pointer-events:none}
    .poster-header{position:absolute;left:0;right:0;top:30px;text-align:center;z-index:2}
    .brand{font-weight:900;color:#d4af37;font-size:16px;letter-spacing:6px;margin-bottom:4px;text-transform:uppercase;text-shadow:0 2px 4px rgba(0,0,0,0.3)}
    .year{color:rgba(255,255,255,0.8);font-size:13px;letter-spacing:2px}
    .avatar-wrap{position:absolute;left:50%;top:95px;transform:translateX(-50%);width:130px;height:130px;border-radius:50%;padding:4px;background:linear-gradient(180deg,#d4af37,#fbf5d5,#d4af37);box-shadow:0 12px 30px rgba(0,0,0,0.4);z-index:3}
    .avatar{width:100%;height:100%;border-radius:50%;background:#eee;overflow:hidden;position:relative;border:4px solid #fff}
    .avatar img{width:100%;height:100%;object-fit:cover;display:block;transform:translate(var(--px,0),var(--py,0)) scale(var(--ps,1))}
    .poster-main{position:absolute;left:20px;right:20px;top:245px;text-align:center;z-index:2}
    .name{font-size:36px;font-weight:900;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,0.4);letter-spacing:2px}
    .meta{margin-top:8px;color:rgba(255,255,255,0.9);font-size:14px;font-weight:500;display:inline-block;padding:4px 14px;border-radius:20px;background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.2)}
    .promo{margin-top:16px;font-size:14px;color:#d4af37;font-weight:700;letter-spacing:1px;opacity:0.9}
    .campaign{margin-top:2px;font-size:24px;color:#fff;font-weight:900;font-style:italic;background:linear-gradient(180deg,#fff 20%,#e0e0e0 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 4px 10px rgba(0,0,0,0.3)}
    .hero-score{margin-top:12px;font-size:76px;font-weight:900;color:#d4af37;line-height:1;text-shadow:0 4px 0 rgba(0,0,0,0.3);font-family:Impact,sans-serif;background:linear-gradient(180deg,#fbf5d5 0%, #d4af37 60%, #a17f1a 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .hero-score .unit{font-size:18px;color:#ffeeb0;font-weight:500;margin-left:4px;font-style:normal;font-family:sans-serif;text-shadow:none;-webkit-text-fill-color:#ffeeb0}
    .score-box{position:absolute;left:24px;right:24px;bottom:34px;background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2);border-radius:18px;padding:16px;display:grid;grid-template-columns:1fr 1fr;gap:0;color:#fff;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,0.2)}
    .score-box > div:first-child{border-right:1px solid rgba(255,255,255,0.15)}
    .score-box .label{font-size:12px;color:rgba(255,255,255,0.6);margin-bottom:4px}
    .score-box .value{font-size:24px;font-weight:700;color:#fff}
    .type-label{position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:#d4af37;color:#2a0333;font-size:12px;font-weight:800;padding:3px 10px;border-radius:4px;box-shadow:0 4px 8px rgba(0,0,0,0.2)}

    .side{display:flex;flex-direction:column;gap:10px}
    .btn{display:inline-block;padding:10px 12px;border-radius:12px;background:#6f42c1;color:#fff;font-weight:700;border:none;cursor:pointer}
    .btn2{display:inline-block;padding:10px 12px;border-radius:12px;background:#fff;color:#6f42c1;font-weight:700;border:1px solid rgba(111,66,193,0.25);cursor:pointer}
    .btnGood{background:#16a34a;color:#fff}
    .btnBad{background:#ef4444;color:#fff}
    .k{font-size:12px;color:#666;line-height:1.6}
    .status{font-size:12px;padding:4px 10px;border-radius:999px;background:rgba(0,0,0,0.06);color:#444;font-weight:700}

    /* Animations */
    .swipe-out-right { animation: swipeRight 0.4s cubic-bezier(0.4,0,0.2,1) forwards; }
    .swipe-out-left { animation: swipeLeft 0.4s cubic-bezier(0.4,0,0.2,1) forwards; }
    .fade-in { animation: fadeIn 0.4s ease forwards; }

    @keyframes swipeRight { to { transform: translateX(120%) rotate(15deg); opacity: 0; } }
    @keyframes swipeLeft { to { transform: translateX(-120%) rotate(-15deg); opacity: 0; } }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
  </style>
</head>
<body>
  <header>
    <div style="font-weight:800">海报工厂 · 审核队列</div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <a href="/admin">返回后台首页</a>
      <a href="/admin/students-db">学生数据库</a>
      <a href="/logout">退出</a>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <div id="empty" class="k" style="display:none">暂无需要生成的海报。请在学生数据库设置海报张数。</div>
      <div id="shell" class="poster-shell" style="display:none">
        <div class="poster-frame">
          <div id="poster" class="poster">
            <div class="poster-bg"></div>
            <div class="poster-header">
              <div class="brand">润德艺考</div>
              <div class="year" id="yearText">—</div>
            </div>
            <div class="avatar-wrap">
              <div class="avatar">
                <img id="avatarImg" src="" alt="avatar">
              </div>
            </div>
            <div class="poster-main">
              <div class="name" id="nameText">—</div>
              <div class="meta" id="metaText">—</div>
              <div id="locationText" style="margin-top:6px;color:rgba(255,255,255,0.7);font-size:13px;font-weight:500">—</div>
              <div class="promo" id="promoText">—</div>
              <div class="campaign" id="campaignText">制霸高分 · 强势上岸</div>
              <div class="hero-score"><span id="heroScore">—</span><span class="unit">分</span></div>
            </div>
            <div class="score-box">
              <div class="type-label" id="typeBadge">主项海报</div>
              <div>
                <div class="label" id="scoreLabel">主项分数</div>
                <div class="value" id="scoreValue">—</div>
              </div>
              <div>
                <div class="label" id="rankLabel">主项排名</div>
                <div class="value" id="rankValue">—</div>
              </div>
            </div>
          </div>
        </div>
        <div class="side">
          <div class="k">快捷键：Enter=合格，Backspace=不合格</div>
          <div class="k">当前状态：<span id="statusTag" class="status">pending</span></div>
          <div class="k">当前学生：<span id="studentId">—</span></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="btnGood" class="btn btnGood" type="button">合格</button>
            <button id="btnBad" class="btn btnBad" type="button">不合格</button>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="btnPrev" class="btn2" type="button">上一张</button>
            <button id="btnNext" class="btn2" type="button">下一张</button>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <a id="btnEdit" class="btn2" href="#">单张精修页</a>
          </div>
          <div>
            <label class="k">海报类型</label>
            <select id="posterType" class="btn2" style="width:100%">
              <option value="main">主项海报</option>
              <option value="sub">副项海报</option>
              <option value="ear">听写海报</option>
              <option value="theory">乐理海报</option>
              <option value="sight">视唱海报</option>
              <option value="total">综合海报</option>
            </select>
          </div>
          <div>
            <label class="k">清晰度</label>
            <select id="quality" class="btn2" style="width:100%">
              <option value="1">社交版 1080×1920</option>
              <option value="1.33">高清 1440×2560</option>
              <option value="2">超清 2160×3840</option>
            </select>
          </div>
          <button id="btnDownload" class="btn" type="button">下载当前海报</button>
        </div>
      </div>
    </div>
  </div>

  <script id="posterData" type="application/json">{{ students|tojson }}</script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    const data = JSON.parse(document.getElementById('posterData').textContent || '[]');
    let idx = 0;
    const rejectCounts = {};

    const $ = (id)=>document.getElementById(id);
    const posterFrame = document.querySelector('.poster-frame');

    function pickPhoto(s){
      const p = s.photo || '';
      return p ? ('/site/' + encodeURI(p)) : '/site/润德1.png';
    }

    function render(){
      if(!data.length){
        $('empty').style.display = 'block';
        $('shell').style.display = 'none';
        return;
      }
      if(idx >= data.length){
        alert('队列已审核完毕！即将返回后台首页。');
        window.location.href = '/admin';
        return;
      }

      $('empty').style.display = 'none';
      $('shell').style.display = 'grid';

      // Animation reset
      posterFrame.className = 'poster-frame fade-in';

      const s = data[idx];
      let posterTypes = Array.isArray(s.posterTypes) ? s.posterTypes : [];
      if(!posterTypes.length && s.posterMode){
        const m = String(s.posterMode);
        if(m === '1') posterTypes = ['main'];
        if(m === '2') posterTypes = ['main','sub'];
        if(m === '3') posterTypes = ['main','sub','total'];
      }
      
      const typeSel = $('posterType');
      const opts = Array.from(typeSel.options).map(o=>o.value);
      const available = opts.filter(v => posterTypes.includes(v));
      if(!available.length){
        typeSel.value = 'main';
        typeSel.disabled = true;
      }else{
        // Preserve selection if possible, else pick first available
        if(!available.includes(typeSel.value)) typeSel.value = available[0];
        typeSel.disabled = false;
      }

      updatePosterInfo(s, typeSel.value);
    }

    function updatePosterInfo(s, type){
      $('nameText').textContent = s.name || '未命名';
      $('yearText').textContent = (s.year || '—') + '届';
      $('metaText').textContent = [s.category, s.mainSubject, s.subSubject].filter(Boolean).join(' · ') || '—';
      const examPlace = [s.examProvince, s.examCity].filter(Boolean).join('');
      $('locationText').textContent = examPlace ? ('考试地：' + examPlace) : '';
      const promo = [s.year ? (s.year + '届') : '', s.examProvince ? (s.examProvince + '省') : '', '音乐联考'].filter(Boolean).join('');
      $('promoText').textContent = promo || '润德艺考 · 音乐联考喜报';
      $('campaignText').textContent = '制霸高分 · 强势上岸';
      $('studentId').textContent = s.id || '—';
      $('statusTag').textContent = s.posterStatus || 'pending';
      $('btnEdit').href = '/admin/poster-factory/' + s.id;

      const avatar = $('avatarImg');
      avatar.src = pickPhoto(s);
      avatar.style.setProperty('--ps', s.posterPhotoScale || '1');
      avatar.style.setProperty('--px', (s.posterPhotoX || '0') + 'px');
      avatar.style.setProperty('--py', (s.posterPhotoY || '0') + 'px');

      if(type === 'main'){
        $('typeBadge').textContent = '主项海报';
        $('scoreLabel').textContent = '主项分数';
        $('rankLabel').textContent = '主项排名';
        $('scoreValue').textContent = s.mainScore || '—';
        $('rankValue').textContent = s.mainRank || '—';
        $('heroScore').textContent = s.mainScore || '—';
      }else if(type === 'sub'){
        $('typeBadge').textContent = '副项海报';
        $('scoreLabel').textContent = '副项分数';
        $('rankLabel').textContent = '专业排名';
        $('scoreValue').textContent = s.subScore || '—';
        $('rankValue').textContent = s.majorRank || '—';
        $('heroScore').textContent = s.subScore || '—';
      }else if(type === 'ear'){
        $('typeBadge').textContent = '听写海报';
        $('scoreLabel').textContent = '听写分数';
        $('rankLabel').textContent = '专业排名';
        $('scoreValue').textContent = s.earTraining || '—';
        $('rankValue').textContent = s.majorRank || '—';
        $('heroScore').textContent = s.earTraining || '—';
      }else if(type === 'theory'){
        $('typeBadge').textContent = '乐理海报';
        $('scoreLabel').textContent = '乐理分数';
        $('rankLabel').textContent = '专业排名';
        $('scoreValue').textContent = s.theory || '—';
        $('rankValue').textContent = s.majorRank || '—';
        $('heroScore').textContent = s.theory || '—';
      }else if(type === 'sight'){
        $('typeBadge').textContent = '视唱海报';
        $('scoreLabel').textContent = '视唱分数';
        $('rankLabel').textContent = '专业排名';
        $('scoreValue').textContent = s.sightSinging || '—';
        $('rankValue').textContent = s.majorRank || '—';
        $('heroScore').textContent = s.sightSinging || '—';
      }else{
        $('typeBadge').textContent = '综合海报';
        $('scoreLabel').textContent = '专业总分';
        $('rankLabel').textContent = '专业排名';
        $('scoreValue').textContent = s.totalScore || '—';
        $('rankValue').textContent = s.majorRank || '—';
        $('heroScore').textContent = s.totalScore || '—';
      }
    }

    const wait = (ms) => new Promise(r => setTimeout(r, ms));

    async function setStatus(status){
      const s = data[idx];
      const fd = new FormData();
      fd.append('status', status);
      
      // Update backend status silently first? or after? 
      // User experience: click -> animate -> finish.
      
      fetch('/admin/poster-factory/' + s.id + '/status', {method:'POST', body: fd}); // Fire and forget for speed feeling

      if(status === 'approved'){
        posterFrame.className = 'poster-frame swipe-out-right';
        s.posterStatus = 'approved';
        $('statusTag').textContent = 'approved';
        await wait(450);
        idx++; // Advance to next
        render();
      } else {
        // Rejected
        s.posterStatus = 'rejected';
        $('statusTag').textContent = 'rejected';
        
        const count = (rejectCounts[s.id] || 0) + 1;
        rejectCounts[s.id] = count;

        if(count >= 3){
          alert('该生（' + s.name + '）已连续 3 次不合格，建议进入“单张精修”进行调整。');
          window.location.href = '/admin/poster-factory/' + s.id;
          return;
        }

        posterFrame.className = 'poster-frame swipe-out-left';
        await wait(450);
        
        // "Regenerate" / Refresh current
        render(); 
        // Note: idx does not increment, so it shows the same student again.
        // The .fade-in animation in render() gives the feeling of a new card appearing.
      }
    }

    function moveManually(step){
       idx += step;
       if(idx < 0) idx = data.length - 1;
       if(idx >= data.length) idx = 0;
       render();
    }

    async function download(){
      const scale = parseFloat($('quality').value || '1');
      const node = $('poster');
      const canvas = await html2canvas(node, {scale});
      const link = document.createElement('a');
      const s = data[idx];
      const type = $('posterType').value;
      link.download = `${s.name || 'poster'}_${type}_${scale}x.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    $('btnGood').addEventListener('click', ()=> setStatus('approved'));
    $('btnBad').addEventListener('click', ()=> setStatus('rejected'));
    
    // Manual navigation buttons (retain old circular behavior or just move?)
    $('btnNext').addEventListener('click', ()=> moveManually(1));
    $('btnPrev').addEventListener('click', ()=> moveManually(-1));
    
    $('btnDownload').addEventListener('click', download);
    $('posterType').addEventListener('change', ()=> updatePosterInfo(data[idx], $('posterType').value));

    document.addEventListener('keydown', (e)=>{
      if($('shell').style.display === 'none') return;
      if(e.key === 'Enter'){ e.preventDefault(); setStatus('approved'); }
      if(e.key === 'Backspace'){ e.preventDefault(); setStatus('rejected'); }
      if(e.key === 'ArrowRight'){ moveManually(1); }
      if(e.key === 'ArrowLeft'){ moveManually(-1); }
    });

    render();
  </script>
</body>
</html>
