<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>海报工厂 - 单张精修</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"PingFang SC",sans-serif;background:#f5f5f7;margin:0}
    header{background:#fff;border-bottom:1px solid rgba(0,0,0,.06);padding:14px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    a{color:#660874;text-decoration:none}
    .wrap{max-width:1200px;margin:22px auto;padding:0 16px}
    .card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.06)}
    .grid{display:grid;grid-template-columns:1.1fr 0.9fr;gap:16px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    label{display:block;margin-top:12px;color:#444;font-size:13px}
    input,select{width:100%;padding:10px 12px;border:1px solid rgba(0,0,0,.12);border-radius:12px;font-size:14px}
    .btn{display:inline-block;margin-top:14px;padding:10px 14px;border-radius:12px;background:#6f42c1;color:#fff;font-weight:700;border:none;cursor:pointer}
    .btn2{display:inline-block;margin-top:14px;padding:10px 14px;border-radius:12px;background:#fff;color:#6f42c1;font-weight:700;border:1px solid rgba(111,66,193,0.25);cursor:pointer}
    /* --- Tech/Commercial Style Poster CSS --- */
    .poster-frame{background:#fff;border-radius:18px;overflow:hidden;border:1px solid rgba(0,0,0,.06);box-shadow:0 20px 48px rgba(0,0,0,0.12)}
    .poster{width:100%;aspect-ratio:9/16;background:#1a0b2e;position:relative;overflow:hidden;color:#fff;font-family:"PingFang SC", sans-serif}
    
    /* Backgrounds */
    .poster-bg-grad {position:absolute;inset:0;background:radial-gradient(circle at 100% 0%, #4a0e69 0%, #1a0b2e 50%, #000 100%); z-index:0;}
    .poster-noise {position:absolute;inset:0;opacity:0.04;background:url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScyMDAlJyBoZWlnaHQ9JzIwMCUnPjxmaWx0ZXIgaWQ9J24nPjxmZVR1cmJ1bGVuY2UgdHlwZT0nZnJhY3RhbE5vaXNlJyBiYXNlRnJlcXVlbmN5PScwLjYnIHN0aXRjaFRpbGVzPSdzdGl0Y2gnLz48L2ZpbHRlcj48cmVjdCB3aWR0aD0nMTAwJScgaGVpZ2h0PScxMDAlJyBmaWxsPSd0cmFuc3BhcmVudCcvPjxyZWN0IHdpZHRoPScxMDAlJyBoZWlnaHQ9JzEwMCUnIGZpbHRlcj0idXJsKCNuKSIgb3BhY2l0eT0iMC41Ii8+PC9zdmc+');pointer-events:none;z-index:0;}
    .poster-blob {position:absolute;width:400px;height:400px;background:#8b2a9b;filter:blur(80px);border-radius:50%;opacity:0.4;top:-100px;left:-100px;z-index:0;}
    .poster-blob2 {position:absolute;width:300px;height:300px;background:#d4af37;filter:blur(90px);border-radius:50%;opacity:0.2;bottom:0;right:-50px;z-index:0;}


    /* Decorations */
    .deco-line {position:absolute;left:24px;top:24px;bottom:24px;width:1px;background:rgba(255,255,255,0.15);z-index:1;}
    .deco-cross {position:absolute;right:24px;top:24px;font-size:24px;font-weight:100;color:rgba(255,255,255,0.3);z-index:1;}
    .deco-circle-line {position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:500px;height:500px;border:1px dashed rgba(255,255,255,0.1);border-radius:50%;pointer-events:none;z-index:0;}

    /* Content Layers */
    .layer-top {position:absolute;top:40px;left:40px;right:24px;z-index:10;}
    /* Removed backdrop-filter as requested, increased opacity for readability */
    .brand-pill {display:inline-flex;align-items:center;padding:6px 14px;background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);border-radius:99px;font-size:12px;font-weight:700;letter-spacing:1px;margin-bottom:14px;color:#fff;}
    .brand-pill span {color:#FFD700;margin-right:6px;}

    .layer-hero {position:absolute;top:120px;left:0;right:0;text-align:center;z-index:5;}
    /* Avatar with Golden Ring */
    .avatar-ring {
      width:140px;height:140px;margin:0 auto;
      border-radius:50%;padding:4px;
      cursor:grab; touch-action:none;
      background:conic-gradient(#FFD700, #FFF, #FFD700, #B8860B, #FFD700);
      box-shadow:0 20px 50px rgba(0,0,0,0.5);
      position:relative;
    }
    .avatar-ring:active {cursor:grabbing;}
    .avatar-inner {width:100%;height:100%;border-radius:50%;background:#000;overflow:hidden;border:4px solid #fff;position:relative;}
    .avatar-inner img {width:100%;height:100%;object-fit:cover;display:block;transform:translate(var(--px,0),var(--py,0)) scale(var(--ps,1)); pointer-events:none;}
    
    /* Name & Title */
    .student-name {font-size:36px;font-weight:900;margin-top:20px;letter-spacing:4px;text-shadow:0 4px 12px rgba(0,0,0,0.5);}
    .category-tag {display:inline-block;margin-top:8px;padding:4px 12px;background:#FFD700;color:#000;font-weight:800;font-size:12px;border-radius:4px;transform:skewX(-10deg);}
    .location-line {margin-top:8px;font-size:13px;color:rgba(255,255,255,0.6);font-weight:400;letter-spacing:2px;}

    /* The BIG Score Section - Moved down to allow space */
    .big-stat-box {position:absolute;top:400px;left:0;right:0;text-align:center;z-index:10;}
    .marketing-text {font-size:32px;font-weight:900;font-style:italic;line-height:1.2;background:linear-gradient(180deg, #fff 40%, #ccc 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 10px 20px rgba(0,0,0,0.5); padding:0 20px;}
    .score-hero {
      font-family:Impact, sans-serif;
      font-size:100px;
      line-height:1.0;
      background:linear-gradient(180deg, #FFD700 20%, #B8860B 80%);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      filter:drop-shadow(0 4px 0px rgba(255,255,255,0.1));
      margin-top:10px;
      display:flex;align-items:baseline;justify-content:center;
    }
    .score-hero .unit {font-size:24px;font-family:sans-serif;font-weight:700;color:rgba(255,255,255,0.8);-webkit-text-fill-color:rgba(255,255,255,0.8);margin-left:6px;}

    /* Glass Panels for Meta Data - Removed blur */
    .glass-deck {position:absolute;bottom:40px;left:24px;right:24px;display:flex;gap:10px;z-index:10;}
    .glass-card {flex:1;background:rgba(20, 10, 30, 0.7);border:1px solid rgba(255,255,255,0.3);border-radius:12px;padding:14px;text-align:left;}
    .glass-card .lbl {font-size:11px;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;}
    .glass-card .val {font-size:20px;font-weight:700;color:#fff;}
    .glass-card .sub {font-size:11px;color:#FFD700;margin-top:2px;}

    /* Floating Badges */
    .float-badge {position:absolute;right:30px;top:380px;background:#FF4500;color:#fff;font-weight:bold;padding:6px 12px;border-radius:8px;font-size:12px;box-shadow:0 8px 16px rgba(255,69,0,0.4);transform:rotate(10deg);z-index:20;}
  </style>
</head>
<body>
  <header>
    <div style="font-weight:800">海报工厂 · 单张精修</div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <a href="/admin/poster-factory">返回审核队列</a>
      <a href="/admin/students-db/{{ student.id }}">学生数据库</a>
      <a href="/logout">退出</a>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <div class="poster-frame">
          <div id="poster" class="poster">
            <div class="poster-bg-grad"></div>
            <div class="poster-noise"></div>
            <div class="poster-blob"></div>
            <div class="poster-blob2"></div>
            
            <div class="deco-line"></div>
            <div class="deco-cross">+</div>
            <div class="deco-circle-line"></div>
            
            <div class="layer-top">
                <div class="brand-pill"><span>RUNDE</span> ART SCHOOL</div>
                <div style="font-size:12px;color:rgba(255,255,255,0.6);letter-spacing:1px" id="yearText">2026 OFFICIAL REPORT —</div>
                <div style="font-size:20px;font-weight:900;margin-top:2px;letter-spacing:2px">润德艺考 · 喜报</div>
            </div>

            <div class="layer-hero">
                <div id="avatarWrap" class="avatar-ring" title="拖拽调整头像位置">
                    <div class="avatar-inner">
                        <img id="avatarImg" src="" alt="avatar">
                    </div>
                </div>
                
                <div class="student-name" id="nameText">—</div>
                <div class="location-line" id="locationText">—</div>
                <div id="metaText" class="category-tag">—</div>
            </div>

            <div class="float-badge" id="floatBadge">TOP 1%</div>

            <div class="big-stat-box">
                <div class="marketing-text" id="campaignText">制霸高分 · 强势上岸</div>
                <div class="score-hero">
                    <span id="heroScore">—</span>
                    <span class="unit" id="heroUnit">分</span>
                </div>
            </div>

            <div class="glass-deck" id="rankDeck">
              <div class="glass-card" id="scoreCard">
                    <div class="lbl" id="scoreLabel">主项分数</div>
                    <div class="val" id="scoreValue">—</div>
                    <div class="sub">超过98%考生</div>
                </div>
              <div class="glass-card" id="rankCard">
                    <div class="lbl" id="rankLabel">主项排名</div>
                    <div class="val" id="rankValue">—</div>
                    <div class="sub">全省前列</div>
                </div>
            </div>
          </div>
        </div>
        <div class="small" style="margin-top:10px">拖拽头像位置，或调整缩放。保存后刷新队列预览。</div>
      </div>

      <div class="card">
        <div id="saveMsg" class="small" style="display:none"></div>
        <form id="f" method="post" action="/admin/poster-factory/{{ student.id }}/save">
          <label>姓名</label>
          <input name="name" value="{{ student.name or '' }}" />

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div>
              <label>专业类别</label>
              <select name="category">
                <option value="">—</option>
                <option value="音乐表演" {{ 'selected' if student.category=='音乐表演' else '' }}>音乐表演</option>
                <option value="音乐教育" {{ 'selected' if student.category=='音乐教育' else '' }}>音乐教育</option>
              </select>
            </div>
            <div>
              <label>年份</label>
              <input name="year" value="{{ student.year or '' }}" />
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div>
              <label>主项</label>
              <input name="mainSubject" value="{{ student.mainSubject or '' }}" />
            </div>
            <div>
              <label>副项</label>
              <input name="subSubject" value="{{ student.subSubject or '' }}" />
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div>
              <label>主项分数</label>
              <input name="mainScore" value="{{ student.mainScore or '' }}" />
            </div>
            <div>
              <label>副项分数</label>
              <input name="subScore" value="{{ student.subScore or '' }}" />
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div>
              <label>专业总分</label>
              <input name="totalScore" value="{{ student.totalScore or '' }}" />
            </div>
            <div>
              <label>专业排名</label>
              <input name="majorRank" value="{{ student.majorRank or '' }}" />
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div>
              <label>主项排名</label>
              <input name="mainRank" value="{{ student.mainRank or '' }}" />
            </div>
            <div>
              <label>海报类型</label>
              <div class="small" style="margin-top:4px">选中哪些，就生成哪些海报</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
                <label><input type="checkbox" name="posterTypes" value="main" {{ 'checked' if 'main' in (student.posterTypes or []) else '' }} /> 主项</label>
                <label><input type="checkbox" name="posterTypes" value="sub" {{ 'checked' if 'sub' in (student.posterTypes or []) else '' }} /> 副项</label>
                <label><input type="checkbox" name="posterTypes" value="ear" {{ 'checked' if 'ear' in (student.posterTypes or []) else '' }} /> 听写</label>
                <label><input type="checkbox" name="posterTypes" value="theory" {{ 'checked' if 'theory' in (student.posterTypes or []) else '' }} /> 乐理</label>
                <label><input type="checkbox" name="posterTypes" value="sight" {{ 'checked' if 'sight' in (student.posterTypes or []) else '' }} /> 视唱</label>
                <label><input type="checkbox" name="posterTypes" value="total" {{ 'checked' if 'total' in (student.posterTypes or []) else '' }} /> 综合</label>
              </div>
            </div>
          </div>

          <label>照片路径</label>
          <input name="photo" id="photoInput" value="{{ student.photo or '' }}" />
          
          <div style="display:flex;align-items:center;margin-top:12px;gap:8px">
             <input type="hidden" name="posterShowRank" id="posterShowRank" value="{{ student.posterShowRank if student.posterShowRank is not none else '1' }}" />
             <input type="checkbox" id="showRank" style="width:auto" {{ 'checked' if (student.posterShowRank is none or student.posterShowRank != '0') else '' }}>
             <span style="font-size:13px;color:#444">显示排名</span>
          </div>

          <div class="small" style="margin-top:6px">头像缩放</div>
          <input id="scale" type="range" min="0.8" max="2" step="0.01" value="{{ student.posterPhotoScale or '1' }}" />

          <input type="hidden" name="posterPhotoScale" id="posterPhotoScale" value="{{ student.posterPhotoScale or '1' }}" />
          <input type="hidden" name="posterPhotoX" id="posterPhotoX" value="{{ student.posterPhotoX or '0' }}" />
          <input type="hidden" name="posterPhotoY" id="posterPhotoY" value="{{ student.posterPhotoY or '0' }}" />

          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px">
            <button class="btn" type="submit">保存</button>
            <button id="btnDownload" class="btn2" type="button">下载当前海报</button>
          </div>

          <label style="margin-top:12px">海报类型</label>
          <select id="posterType" class="btn2" style="width:100%">
            <option value="main">主项海报</option>
            <option value="sub">副项海报</option>
            <option value="ear">听写海报</option>
            <option value="theory">乐理海报</option>
            <option value="sight">视唱海报</option>
            <option value="total">综合海报</option>
          </select>

          <label style="margin-top:12px">清晰度</label>
          <select id="quality" class="btn2" style="width:100%">
            <option value="1">社交版 1080×1920</option>
            <option value="1.33">高清 1440×2560</option>
            <option value="2">超清 2160×3840</option>
          </select>
        </form>
      </div>
    </div>
  </div>

  <script id="posterItem" type="application/json">{{ student|tojson }}</script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    const s = JSON.parse(document.getElementById('posterItem').textContent || '{}');
    const $ = (id)=>document.getElementById(id);

    function pickPhoto(){
      const p = $('photoInput').value || '';
      return p ? ('/site/' + encodeURI(p)) : '/site/润德1.png';
    }

    function render(type){
      s.name = $('f').elements['name'].value || s.name;
      s.category = $('f').elements['category'].value || s.category;
      s.year = $('f').elements['year'].value || s.year;
      s.mainSubject = $('f').elements['mainSubject'].value || s.mainSubject;
      s.subSubject = $('f').elements['subSubject'].value || s.subSubject;
      s.mainScore = $('f').elements['mainScore'].value || s.mainScore;
      s.subScore = $('f').elements['subScore'].value || s.subScore;
      s.totalScore = $('f').elements['totalScore'].value || s.totalScore;
      s.majorRank = $('f').elements['majorRank'].value || s.majorRank;
      s.mainRank = $('f').elements['mainRank'].value || s.mainRank;

      $('nameText').textContent = s.name || '未命名';
      $('yearText').textContent = (s.year || '2026') + ' OFFICIAL REPORT —';
      $('metaText').textContent = [s.category, s.mainSubject, s.subSubject].filter(Boolean).join(' / ') || '—';
      const examPlace = [s.examProvince, s.examCity].filter(Boolean).join(' · ');
      $('locationText').textContent = examPlace || '—';
      
      const avatar = $('avatarImg');
      avatar.src = pickPhoto();
      
      // Update Transform directly
      updateAvatarTransform();

      const posterType = type || $('posterType').value || 'main';
      const showRank = $('showRank').checked;
      $('posterShowRank').value = showRank ? '1' : '0';
      $('rankCard').style.display = showRank ? '' : 'none';
      
      // --- Logic Differentiation ---
      let slogan = '制霸高分 · 强势上岸';
      let floatText = 'TOP 5%';
      
      if(posterType === 'main'){
        $('scoreLabel').textContent = '主项分数';
        $('rankLabel').textContent = '主项排名';
        $('scoreValue').textContent = s.mainScore || '—';
        $('rankValue').textContent = s.mainRank || '—';
        $('heroScore').textContent = s.mainScore || '—';
        $('heroUnit').textContent = '分';
        slogan = '主项强基 · 技压群雄';
        floatText = '单科状元';
      }else if(posterType === 'sub'){
        $('scoreLabel').textContent = '副项分数';
        $('rankLabel').textContent = '专业排名';
        $('scoreValue').textContent = s.subScore || '—';
        $('rankValue').textContent = s.majorRank || '—';
        $('heroScore').textContent = s.subScore || '—';
        $('heroUnit').textContent = '分';
        slogan = '多才多艺 · 全面开花';
        floatText = '全能发展';
      }else if(posterType === 'ear'){
        $('scoreLabel').textContent = '听写分数';
        $('rankLabel').textContent = '专业排名';
        $('scoreValue').textContent = s.earTraining || '—';
        $('rankValue').textContent = s.majorRank || '—';
        $('heroScore').textContent = s.earTraining || '—';
        $('heroUnit').textContent = '分';
        slogan = '听音辨位 · 满分实力';
        floatText = '基本功';
      }else if(posterType === 'theory'){
        $('scoreLabel').textContent = '乐理分数';
        $('rankLabel').textContent = '专业排名';
        $('scoreValue').textContent = s.theory || '—';
        $('rankValue').textContent = s.majorRank || '—';
        $('heroScore').textContent = s.theory || '—';
        $('heroUnit').textContent = '分';
        slogan = '乐理满分 · 基础扎实';
        floatText = '理论满分';
      }else if(posterType === 'sight'){
        $('scoreLabel').textContent = '视唱分数';
        $('rankLabel').textContent = '专业排名';
        $('scoreValue').textContent = s.sightSinging || '—';
        $('rankValue').textContent = s.majorRank || '—';
        $('heroScore').textContent = s.sightSinging || '—';
        $('heroUnit').textContent = '分';
        slogan = '视唱练耳 · 唯快不破';
        floatText = '视唱满分';
      }else{
        // Total
        $('scoreLabel').textContent = '专业总分';
        $('rankLabel').textContent = '全省排名';
        $('scoreValue').textContent = s.totalScore || '—';
        $('rankValue').textContent = s.majorRank || '—';
        $('heroScore').textContent = s.totalScore || '—';
        
        $('heroUnit').textContent = '分';
        slogan = '制霸考场 · 综合王者';
        floatText = '全省前茅';
      }
      
      $('campaignText').textContent = slogan;
      $('floatBadge').textContent = floatText;
    }

    function updateAvatarTransform() {
        const ps = $('posterPhotoScale').value || '1';
        const px = $('posterPhotoX').value || '0';
        const py = $('posterPhotoY').value || '0';
        const avatar = $('avatarImg');
        avatar.style.setProperty('--ps', ps);
        avatar.style.setProperty('--px', px + 'px');
        avatar.style.setProperty('--py', py + 'px');
    }

    // drag to move avatar
    const avatarWrap = $('avatarWrap');
    let dragging = false;
    let startX = 0, startY = 0;
    let baseX = 0, baseY = 0;

    function startDrag(clientX, clientY) {
      dragging = true;
      startX = clientX;
      startY = clientY;
      baseX = parseFloat($('posterPhotoX').value || '0');
      baseY = parseFloat($('posterPhotoY').value || '0');
    }

    function moveDrag(clientX, clientY) {
      if(!dragging) return;
      const dx = clientX - startX;
      const dy = clientY - startY;
      const nx = baseX + dx;
      const ny = baseY + dy;
      $('posterPhotoX').value = String(Math.round(nx));
      $('posterPhotoY').value = String(Math.round(ny));
      updateAvatarTransform();
    }

    function endDrag() {
      dragging = false;
    }

    if (window.PointerEvent) {
      avatarWrap.addEventListener('pointerdown', (e)=>{
        startDrag(e.clientX, e.clientY);
        try { avatarWrap.setPointerCapture(e.pointerId); } catch {}
      });
      avatarWrap.addEventListener('pointermove', (e)=> moveDrag(e.clientX, e.clientY));
      avatarWrap.addEventListener('pointerup', endDrag);
      avatarWrap.addEventListener('pointercancel', endDrag);
    } else {
      avatarWrap.addEventListener('mousedown', (e)=> startDrag(e.clientX, e.clientY));
      window.addEventListener('mousemove', (e)=> moveDrag(e.clientX, e.clientY));
      window.addEventListener('mouseup', endDrag);
      avatarWrap.addEventListener('touchstart', (e)=>{
        if(!e.touches || !e.touches[0]) return;
        e.preventDefault();
        startDrag(e.touches[0].clientX, e.touches[0].clientY);
      }, {passive:false});
      window.addEventListener('touchmove', (e)=>{
        if(!e.touches || !e.touches[0]) return;
        e.preventDefault();
        moveDrag(e.touches[0].clientX, e.touches[0].clientY);
      }, {passive:false});
      window.addEventListener('touchend', endDrag);
      window.addEventListener('touchcancel', endDrag);
    }

    $('scale').addEventListener('input', ()=>{
      $('posterPhotoScale').value = $('scale').value;
      updateAvatarTransform(); // Call lightweight update instead of full render
    });

    $('photoInput').addEventListener('change', () => render());
    $('posterType').addEventListener('change', () => render());
    $('showRank').addEventListener('change', () => render());

    Array.from($('f').elements).forEach(el=>{
      if(el && el.tagName && (el.tagName === 'INPUT' || el.tagName === 'SELECT')){
         // Avoid recursive loops or overwriting, just general update
         // Only trigger full render if it's NOT one of the photo controls (handled separately)
         if(!['scale','posterPhotoX','posterPhotoY','posterPhotoScale'].includes(el.id)) {
            el.addEventListener('input', ()=> render()); // Remove 'main' arg to allow auto-detection
         }
      }
    });

    $('f').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData($('f'));
      const resp = await fetch($('f').action, {method:'POST', body: fd});
      const msg = $('saveMsg');
      if(resp.ok){
        msg.textContent = '已保存';
        msg.style.display = 'block';
        msg.style.color = '#1d6a2b';
      }else{
        msg.textContent = '保存失败';
        msg.style.display = 'block';
        msg.style.color = '#c21a12';
      }
      setTimeout(()=>{ msg.style.display = 'none'; }, 1200);
    });

    async function download(){
      const scale = parseFloat($('quality').value || '1');
      const node = $('poster');
      const canvas = await html2canvas(node, {scale});
      const link = document.createElement('a');
      const type = $('posterType').value || 'main';
      link.download = `${s.name || 'poster'}_${type}_${scale}x.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    $('btnDownload').addEventListener('click', download);

    let types = Array.isArray(s.posterTypes) ? s.posterTypes : [];
    if(!types.length && s.posterMode){
      const m = String(s.posterMode);
      if(m === '1') types = ['main'];
      if(m === '2') types = ['main','sub'];
      if(m === '3') types = ['main','sub','total'];
    }
    if(types.length){
      $('posterType').value = types[0];
    }
    // Ensure checkbox is consistent with persisted value
    if($('posterShowRank').value === '0') $('showRank').checked = false;
    render();
  </script>
</body>
</html>
