<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>部署与同步 · 管理后台</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"PingFang SC",sans-serif;background:#f5f5f7;margin:0}
    header{background:#fff;border-bottom:1px solid rgba(0,0,0,.06);padding:14px 18px;display:flex;align-items:center;justify-content:space-between;gap:14px}
    a{color:#660874;text-decoration:none}
    .wrap{max-width:1040px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
    .card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.06)}
    .k{color:#666;font-size:13px}
    .v{font-size:18px;font-weight:700;margin-top:6px;word-break:break-word}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:rgba(102,8,116,.08);color:#660874;font-weight:700;font-size:12px}
    .btn{display:inline-block;padding:10px 12px;border-radius:12px;background:#660874;color:#fff;font-weight:700;border:0;cursor:pointer}
    .btn.secondary{background:#111827}
    .btn.ghost{background:transparent;color:#660874;border:1px solid rgba(102,8,116,.35)}
    .muted{color:#666;font-size:13px;line-height:1.6}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    td,th{font-size:13px;text-align:left;vertical-align:top}
    th{color:#666;font-weight:700}
    .row{background:#fafafa;border:1px solid rgba(0,0,0,.06);border-radius:14px}
    .row td{padding:10px 12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .flash{padding:10px 12px;border-radius:12px;margin:0 0 14px 0;border:1px solid rgba(0,0,0,.08)}
    .flash.ok{background:rgba(16,185,129,.08);border-color:rgba(16,185,129,.25)}
    .flash.error{background:rgba(239,68,68,.07);border-color:rgba(239,68,68,.20)}
  </style>
</head>
<body>
  <header>
    <div style="font-weight:800">部署与同步</div>
    <div style="display:flex;gap:12px;align-items:center">
      <a href="/admin">返回首页</a>
      <a href="/logout">退出</a>
    </div>
  </header>

  <div class="wrap">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="grid">
      <div class="card">
        <div class="k">站点写入模式</div>
        <div class="v"><span class="pill">{{ site_mode }}</span></div>
        <div class="muted" style="margin-top:10px">
          <div>public：写入 public/（控制线上前台）</div>
          <div>local：写入 data/（本地工具）</div>
        </div>
      </div>
      <div class="card">
        <div class="k">存储模式</div>
        <div class="v"><span class="pill">{{ storage_mode }}</span></div>
        <div class="muted" style="margin-top:10px">
          github：每次保存都会提交到 GitHub，Cloudflare 自动部署更新。
        </div>
      </div>
      <div class="card">
        <div class="k">GitHub 仓库</div>
        <div class="v mono">{{ github_repo or '—' }}</div>
        <div class="muted" style="margin-top:10px">分支：<span class="mono">{{ github_branch or '—' }}</span></div>
        {% if github_commit_url %}
          <div style="margin-top:10px"><a class="btn ghost" href="{{ github_commit_url }}" target="_blank" rel="noreferrer">查看最新提交</a></div>
        {% endif %}
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <div>
          <div style="font-weight:800">快速回滚（最近提交）</div>
          <div class="muted">如果误操作导致前台显示异常，可把某个 JSON 回滚到之前的版本（会产生一次新的 Git 提交）。</div>
        </div>
      </div>

      {% if not github_enabled %}
        <div class="muted" style="margin-top:10px">当前未启用 GitHub 存储模式，无法展示/回滚提交历史。</div>
      {% else %}
        {% for item in files %}
          <div style="margin-top:18px">
            <div style="font-weight:800">{{ item.title }} <span class="muted">（{{ item.repo_path }}）</span></div>
            <table>
              <thead>
                <tr>
                  <th style="width:140px">时间</th>
                  <th>提交信息</th>
                  <th style="width:110px">操作</th>
                </tr>
              </thead>
              <tbody>
                {% for c in item.commits %}
                  <tr class="row">
                    <td class="muted">{{ c.date }}</td>
                    <td>
                      <div style="font-weight:700">{{ c.message }}</div>
                      <div class="muted mono" style="margin-top:6px">{{ c.sha }}</div>
                      {% if c.url %}
                        <div style="margin-top:6px"><a href="{{ c.url }}" target="_blank" rel="noreferrer">打开提交</a></div>
                      {% endif %}
                    </td>
                    <td>
                      <form method="post" action="/admin/ops/rollback" onsubmit="return confirm('确定回滚【{{ item.title }}】到该版本吗？这会生成一次新的 Git 提交，并触发 Cloudflare 自动部署。');">
                        <input type="hidden" name="key" value="{{ item.key }}" />
                        <input type="hidden" name="sha" value="{{ c.sha }}" />
                        <button class="btn" type="submit">回滚</button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endfor %}
      {% endif %}
    </div>

    <div class="muted" style="margin-top:14px">
      提示：回滚后 Cloudflare 需要几十秒到几分钟完成重新部署。
    </div>
  </div>
</body>
</html>
